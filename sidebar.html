<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript">
  var deletimer = -1;
  var intcount = 0;
  function listFiles(data) {
    $('#file_list').html($('<h2></h2>').text("Filer i autopass-mappen som ikke er eksportert"));
    $('#spinner').text('');
    clearTimeouts();
    var txt = "";
    var ul = $("<ul></ul>");
    var sp = 'Eksporterer';
    if (!data.length) {
      $('#file_list').text("Ingen uhånterte filer!");
      return;
    }
    for(i=0; i<data.length; i++){
      var b = $("<button></button>");
      b.addClass("export");
      b.text("Eksporter til JSON");
      $(document).on("click", ".export", function(event) {
        $('#spinner').text(sp);
        deletimer = setInterval(function() {
          $('#spinner').text(sp + (Array(intcount%4+1).join(".")));
          intcount++;
        }, 500);
        google.script.run.withSuccessHandler(exportedFile)
          .autopass_JSON_convert($(event.target).parent('li').attr("id"));
      });
      ul.append($("<li></li>").attr("id", data[i].id).append(data[i].name + " ").append(b));
    }
    $('#file_list').append(ul);
  }
  function exportedFile(data) {
    clearTimeouts();
    $('#spinner').text('');
    $("#" + data.fid + ' .export').remove()
    $("#" + data.fid).html($('<a></a>').attr('href', data.url).text('Last ned ' + data.name));
  }
  function getFileList() {
    // display folders:
    $("#folders").empty()
    
    google.script.run.withSuccessHandler(showFolder).getFolderUrls("autopass", "json");
    
    $('#file_list').text('');
    var sp = 'Laster fil-liste'
    deletimer = setInterval(function() {
      $('#spinner').text(sp + (Array(intcount%4+1).join(".")));
      intcount++;
    }, 500);
    google.script.run.withSuccessHandler(listFiles).listUhandledFiles();
  }
  function clearTimeouts() {
    for (var i = 1; i < deletimer + 50; i++) {
      window.clearInterval(i);
    }
  }
  function showFolder(data) {
    for (var i=0; i<data.length; i++) {
      $("#folders")
        .append($('<a></a>').attr('href', data[i].url).attr('target', '_blank').text(data[i].name))
        .append($('<br/>'))
    }
  }
  function exportInit() {
    google.script.run.withSuccessHandler(exportSetup).isSetup();
  }
  function exportSetup(data) {
    if (data) {
      getFileList();
    }
    else {
      $("#folders").html(
        "Oppretter SETUP - ark og data-mapper. <br/> " +
        "Du må legge inn autopass-data i autopass-mappen for å prosessere disse.<br/>" +
        "Klikk på 'Oppdater fil-liste' for få lenker til mappene.<br/>" +
        "Etter du har lagt inn filer kan du klikke på knappen igjen for å starte fil-eksport."
      );
    }
  }
    </script>
  </head>
  <body onLoad="exportInit()">
    <h1>Eksportverktøy</h1>
    <h3>Data-mapper</h3>
    <div id="folders" style="padding: 0 0 20px 0;"></div>
    <button onClick="getFileList()">Oppdater fil-liste</button>
    <br/><br/>
    <div id="spinner"></div>
    <br/>
    <div id="file_list"></div>
  </body>
</html>
